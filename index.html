<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

  <!-- PWA / iOS -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Newcom">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#0f0a1e">

  <!-- Android / Chrome PWA -->
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-192.png">

  <title>Newcom Team Builder</title>

  <style>
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       BASE â€” compatible iOS 7+ / Android 4.1+
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    html {
      -webkit-text-size-adjust: 100%;
      -ms-text-size-adjust: 100%;
    }
    *, *:before, *:after {
      -webkit-box-sizing: border-box;
      -moz-box-sizing: border-box;
      box-sizing: border-box;
      margin: 0; padding: 0;
    }

    body {
      font-family: -apple-system, 'Helvetica Neue', 'Arial', sans-serif;
      background-color: #0f0a1e;
      min-height: 100vh;
      color: #ffffff;
      font-size: 16px;
      /* Prevent iOS bounce scroll interfering with drag */
      overflow-x: hidden;
      -webkit-overflow-scrolling: touch;
    }

    /* Safe areas para iPhones con notch */
    .app {
      max-width: 1024px;
      margin: 0 auto;
      padding: 16px;
      padding-left: max(16px, env(safe-area-inset-left));
      padding-right: max(16px, env(safe-area-inset-right));
      padding-bottom: max(16px, env(safe-area-inset-bottom));
    }

    /* â”€â”€ Gradiente de fondo â”€â”€ */
    body:before {
      content: '';
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background:
        -webkit-radial-gradient(20% 50%, ellipse, #1e0a3c 0%, transparent 60%),
        -webkit-radial-gradient(80% 20%, ellipse, #0a1a3c 0%, transparent 60%);
      background:
        radial-gradient(ellipse at 20% 50%, #1e0a3c 0%, transparent 60%),
        radial-gradient(ellipse at 80% 20%, #0a1a3c 0%, transparent 60%);
      pointer-events: none;
      z-index: 0;
    }
    .app { position: relative; z-index: 1; }

    /* â”€â”€ TipografÃ­a â”€â”€ */
    h1 { font-size: 2.4rem; font-weight: 900; letter-spacing: 0.08em; text-transform: uppercase; }
    h2 { font-size: 1.3rem; font-weight: 800; letter-spacing: 0.05em; text-transform: uppercase; }
    h3 { font-size: 1.4rem; font-weight: 800; letter-spacing: 0.04em; text-transform: uppercase; }

    /* â”€â”€ Header â”€â”€ */
    .header { text-align: center; margin-bottom: 18px; }
    .header h1 {
      background: -webkit-linear-gradient(135deg, #a855f7, #ec4899, #a855f7);
      background: linear-gradient(135deg, #a855f7, #ec4899, #a855f7);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    /* Fallback para browsers que no soportan text-fill */
    .header h1 span { color: #a855f7; }
    .header p {
      color: #a78bfa;
      font-size: 0.68rem;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      margin-top: 4px;
    }

    /* â”€â”€ Instalar banner (iOS) â”€â”€ */
    .install-banner {
      background: rgba(124,58,237,0.25);
      border: 1px solid #7c3aed;
      border-radius: 10px;
      padding: 10px 14px;
      margin-bottom: 14px;
      font-size: 0.78rem;
      color: #c4b5fd;
      display: -webkit-box; display: -webkit-flex; display: flex;
      -webkit-box-align: center; -webkit-align-items: center; align-items: center;
      gap: 8px;
    }
    .install-banner button {
      margin-left: auto;
      background: none; border: none;
      color: #a78bfa; font-size: 1.1rem; cursor: pointer;
      -webkit-tap-highlight-color: transparent;
    }

    /* â”€â”€ Tabs â”€â”€ */
    .tabs {
      display: -webkit-box; display: -webkit-flex; display: flex;
      gap: 8px;
      background: rgba(30,20,60,0.92);
      border: 2px solid #7c3aed;
      border-radius: 12px;
      padding: 8px;
      margin-bottom: 16px;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    .tabs::-webkit-scrollbar { height: 3px; }
    .tabs::-webkit-scrollbar-thumb { background: #7c3aed; border-radius: 3px; }

    .tab-btn {
      -webkit-flex-shrink: 0; flex-shrink: 0;
      padding: 11px 20px;
      border-radius: 8px;
      font-weight: 700;
      font-size: 0.82rem;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      border: none;
      cursor: pointer;
      white-space: nowrap;
      -webkit-tap-highlight-color: transparent;
      -webkit-transition: background 0.2s; transition: background 0.2s;
    }
    .tab-db           { background: #3b0764; color: #c4b5fd; }
    .tab-db.active    { background: #7c3aed; color: #fff; }
    .tab-teams        { background: #14532d; color: #86efac; }
    .tab-teams.active { background: #16a34a; color: #fff; }

    /* â”€â”€ Paneles â”€â”€ */
    .panel {
      background: rgba(20,10,40,0.88);
      border: 2px solid #7c3aed;
      border-radius: 14px;
      padding: 16px;
      margin-bottom: 14px;
    }
    .panel-orange { border-color: #f97316; }

    /* â”€â”€ Botones â”€â”€ */
    .btn {
      display: -webkit-inline-box; display: -webkit-inline-flex; display: inline-flex;
      -webkit-box-align: center; -webkit-align-items: center; align-items: center;
      gap: 6px;
      padding: 12px 20px;
      border-radius: 10px;
      font-weight: 700;
      font-size: 0.84rem;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      border: none;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
      -webkit-transition: opacity 0.15s; transition: opacity 0.15s;
      /* Bigger touch targets */
      min-height: 44px;
    }
    .btn:active { opacity: 0.75; }
    .btn-purple { background: #7c3aed; color: #fff; }
    .btn-green  { background: #16a34a; color: #fff; }
    .btn-orange { background: #ea580c; color: #fff; }
    .btn-red    { background: #dc2626; color: #fff; }
    .btn-gray   { background: #374151; color: #6b7280; }

    .btn-row {
      display: -webkit-box; display: -webkit-flex; display: flex;
      gap: 10px;
      -webkit-flex-wrap: wrap; flex-wrap: wrap;
      -webkit-box-pack: center; -webkit-justify-content: center; justify-content: center;
      margin-bottom: 14px;
    }

    /* â”€â”€ Formulario â”€â”€ */
    .form-grid {
      display: -webkit-box; display: -webkit-flex; display: flex;
      -webkit-flex-wrap: wrap; flex-wrap: wrap;
      gap: 14px;
    }
    .form-group { -webkit-flex: 1 1 200px; flex: 1 1 200px; }
    .form-full  { -webkit-flex: 1 1 100%;  flex: 1 1 100%;  }

    .form-group label {
      display: block;
      color: #c4b5fd;
      font-size: 0.72rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      margin-bottom: 6px;
      font-weight: 700;
    }
    .form-group input[type="text"],
    .form-group select {
      width: 100%;
      background: #0a0618;
      border: 2px solid #7c3aed;
      border-radius: 8px;
      padding: 12px 14px;
      color: #fff;
      font-size: 1rem;
      outline: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      /* iOS needs explicit height for selects */
      min-height: 44px;
    }
    .form-group input[type="text"]:focus,
    .form-group select:focus { border-color: #ec4899; }
    .form-group input[type="range"] {
      width: 100%;
      margin-top: 6px;
      height: 30px; /* bigger touch area */
      -webkit-appearance: none;
      appearance: none;
      background: #3b0764;
      border-radius: 4px;
      outline: none;
    }
    .form-group input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 26px; height: 26px;
      border-radius: 50%;
      background: #a855f7;
      cursor: pointer;
    }
    .form-actions {
      display: -webkit-box; display: -webkit-flex; display: flex;
      gap: 10px; margin-top: 14px;
    }

    /* â”€â”€ Tarjetas de jugadores (Base de datos) â”€â”€ */
    .players-grid {
      display: -webkit-box; display: -webkit-flex; display: flex;
      -webkit-flex-wrap: wrap; flex-wrap: wrap;
      gap: 10px;
    }
    .player-card {
      -webkit-flex: 1 1 170px; flex: 1 1 170px;
      max-width: 230px;
      background: #0a0618;
      border: 2px solid #374151;
      border-radius: 10px;
      padding: 10px 12px;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
      position: relative;
      /* Hardware acceleration para animaciones suaves en iOS */
      -webkit-transform: translateZ(0);
      transform: translateZ(0);
    }
    .player-card.present {
      border-color: #22c55e;
      background: rgba(20,60,30,0.65);
    }
    .player-card.absent { opacity: 1; background: #0a0618; border-color: #374151; }
    .player-card-name { font-weight: 700; font-size: 0.9rem; margin-bottom: 6px; padding-right: 46px; color: #ffffff; }
    /* Nombre siempre iluminado */
    .player-card.present .player-card-name { color: #dcfce7; text-shadow: 0 0 8px rgba(74,222,128,0.5); }
    .player-card.absent  .player-card-name { color: #ffffff; }
    /* Badges y resto atenuados cuando ausente */
    .player-card.absent .badges      { opacity: 0.35; }
    .player-card.absent .card-actions { opacity: 0.45; }

    .card-actions {
      position: absolute; top: 8px; right: 8px;
      display: -webkit-box; display: -webkit-flex; display: flex;
      gap: 4px;
    }
    .icon-btn {
      background: none; border: none; cursor: pointer;
      padding: 4px;
      min-width: 32px; min-height: 32px;
      display: -webkit-box; display: -webkit-flex; display: flex;
      -webkit-box-align: center; -webkit-align-items: center; align-items: center;
      -webkit-box-pack: center; -webkit-justify-content: center; justify-content: center;
      -webkit-tap-highlight-color: transparent;
      border-radius: 6px;
    }
    .icon-btn-edit { color: #60a5fa; }
    .icon-btn-del  { color: #f87171; }

    .badges {
      display: -webkit-box; display: -webkit-flex; display: flex;
      -webkit-flex-wrap: wrap; flex-wrap: wrap;
      gap: 4px; margin-bottom: 6px;
    }
    .badge {
      padding: 3px 8px; border-radius: 5px;
      font-size: 0.68rem; font-weight: 700; color: #fff;
    }
    .b-blue   { background: #1d4ed8; }
    .b-pink   { background: #be185d; }
    .b-orange { background: #c2410c; }
    .b-cyan   { background: #0e7490; }
    .b-green  { background: #15803d; }

    .scores-row { display: -webkit-box; display: -webkit-flex; display: flex; gap: 6px; }
    .score-box  { -webkit-flex: 1; flex: 1; border-radius: 5px; padding: 3px 7px; font-size: 0.7rem; font-weight: 700; }
    .s-tira { background: rgba(194,65,12,0.22); color: #fb923c; }
    .s-zag  { background: rgba(14,116,144,0.22); color: #22d3ee; }

    /* â”€â”€ Alertas â”€â”€ */
    .alert-warn {
      background: rgba(120,80,0,0.3); border: 1px solid #b45309;
      border-radius: 8px; padding: 10px 14px;
      margin-bottom: 12px; font-size: 0.8rem; color: #fde68a;
    }
    .alert-err {
      background: rgba(120,0,0,0.3); border: 1px solid #b91c1c;
      border-radius: 6px; padding: 6px 10px;
      margin-bottom: 8px; font-size: 0.74rem; color: #fca5a5;
    }

    /* â”€â”€ Grilla de equipos â”€â”€ */
    .teams-grid {
      display: -webkit-box; display: -webkit-flex; display: flex;
      -webkit-flex-wrap: wrap; flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 18px;
    }
    .team-card {
      -webkit-flex: 1 1 280px; flex: 1 1 280px;
      border: 2px solid;
      border-radius: 14px;
      padding: 14px;
      min-width: 0;
      -webkit-transform: translateZ(0);
      transform: translateZ(0);
    }
    .team-card.drop-over {
      outline: 3px dashed rgba(255,255,255,0.55);
      outline-offset: -4px;
    }

    .team-header {
      display: -webkit-box; display: -webkit-flex; display: flex;
      -webkit-box-pack: justify; -webkit-justify-content: space-between; justify-content: space-between;
      -webkit-box-align: center; -webkit-align-items: center; align-items: center;
      margin-bottom: 10px;
    }
    .team-pts   { font-size: 1.05rem; font-weight: 800; color: #fbbf24; }
    .team-count { font-size: 0.68rem; color: #a78bfa; }

    /* Separador entre tiradores y zagueros */
    .pos-divider {
      border: none;
      border-top: 1px solid rgba(255,255,255,0.1);
      margin: 4px 0;
    }

    /* â”€â”€ Filas de jugador en equipo â”€â”€ */
    .player-row {
      display: -webkit-box; display: -webkit-flex; display: flex;
      -webkit-box-align: center; -webkit-align-items: center; align-items: center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 7px;
      /* Sin cursor:grab para tÃ¡ctil â€” lo manejamos con JS */
      -webkit-tap-highlight-color: transparent;
      -webkit-user-select: none;
      -moz-user-select: none;
      user-select: none;
      touch-action: none;
    }
    .player-row:active { background: rgba(255,255,255,0.08); }
    .player-row.dragging { opacity: 0.3; }

    .tz {
      font-weight: 900;
      font-size: 0.9rem;
      width: 18px;
      text-align: center;
      -webkit-flex-shrink: 0; flex-shrink: 0;
    }
    .tz-m { color: #60a5fa; } /* azul â€” varÃ³n  */
    .tz-f { color: #f87171; } /* rojo â€” mujer  */

    .p-name {
      font-size: 0.92rem;
      font-weight: 600;
      -webkit-flex: 1; flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .drop-hint {
      text-align: center; color: #4b5563;
      font-size: 0.74rem; padding: 10px;
      border: 1px dashed #374151; border-radius: 6px;
    }

    /* â”€â”€ Banca â”€â”€ */
    .bench-grid {
      display: -webkit-box; display: -webkit-flex; display: flex;
      -webkit-flex-wrap: wrap; flex-wrap: wrap;
      gap: 8px;
    }
    .bench-chip {
      display: -webkit-box; display: -webkit-flex; display: flex;
      -webkit-box-align: center; -webkit-align-items: center; align-items: center;
      gap: 6px;
      background: #0a0618;
      border: 1px solid #ea580c;
      border-radius: 8px;
      padding: 8px 14px;
      min-height: 40px;
      -webkit-tap-highlight-color: transparent;
      -webkit-user-select: none;
      -moz-user-select: none;
      user-select: none;
      touch-action: none;
    }
    .bench-chip.dragging { opacity: 0.3; }

    /* â”€â”€ Colores de equipos â”€â”€ */
    .tc0 { border-color:#22c55e; background:rgba(20,60,30,0.55); }
    .tc1 { border-color:#3b82f6; background:rgba(20,30,80,0.55); }
    .tc2 { border-color:#ec4899; background:rgba(70,10,50,0.55); }
    .tc3 { border-color:#eab308; background:rgba(60,50,5,0.55);  }
    .tc4 { border-color:#f97316; background:rgba(70,30,5,0.55);  }
    .tc5 { border-color:#06b6d4; background:rgba(5,50,60,0.55);  }
    .tt0 { color:#4ade80; } .tt1 { color:#60a5fa; } .tt2 { color:#f472b6; }
    .tt3 { color:#fde047; } .tt4 { color:#fb923c; } .tt5 { color:#22d3ee; }

    /* â”€â”€ Ghost de arrastre â”€â”€ */
    #drag-ghost {
      position: fixed;
      display: none;
      z-index: 9999;
      background: rgba(109,40,217,0.95);
      border: 2px solid #a855f7;
      border-radius: 9px;
      padding: 7px 16px;
      font-size: 0.88rem;
      font-weight: 700;
      color: #fff;
      white-space: nowrap;
      pointer-events: none;
      -webkit-transform: translate(-50%, -100%);
      transform: translate(-50%, -100%);
      margin-top: -14px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.6);
    }

    /* â”€â”€ Hint arrastre â”€â”€ */
    .drag-hint {
      text-align: center;
      color: #6d28d9;
      font-size: 0.7rem;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      margin-bottom: 12px;
    }

    /* â”€â”€ Footer â”€â”€ */
    .footer {
      text-align: center;
      margin-top: 24px;
      padding-bottom: 20px;
      color: #4c1d95;
      font-size: 0.68rem;
      letter-spacing: 0.08em;
    }

    /* â”€â”€ Media queries para iPad 3Âª gen (2048Ã—1536 px, ~9.7") â”€â”€ */
    @media screen and (min-width: 768px) {
      h1 { font-size: 3rem; }
      .player-card { -webkit-flex: 1 1 200px; flex: 1 1 200px; }
      .team-card   { -webkit-flex: 1 1 320px; flex: 1 1 320px; }
      .tab-btn     { font-size: 0.88rem; padding: 12px 22px; }
    }
    @media screen and (min-width: 1024px) {
      .team-card { -webkit-flex: 1 1 300px; flex: 1 1 300px; }
    }
  </style>
</head>
<body>

<!-- Ghost visual del drag -->
<div id="drag-ghost"></div>

<div class="app" id="app"></div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   NEWCOM TEAM BUILDER â€” iOS 3Âª gen + Android compatible
   Vanilla JS, sin frameworks. ES5 puro.
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* â”€â”€ Estado global â”€â”€ */
var S = {
  players:    [],
  teams:      null,   // [[player,...], ...]  â€” siempre 6 por equipo
  bench:      [],     // jugadores presentes sin equipo
  view:       'database',
  showForm:   false,
  editId:     null,
  form:       { name:'', sex:'M', tiradorScore:5, zagueroScore:5, position:'tirador' },
  showBanner: false,  // banner "agregÃ¡ a pantalla de inicio"
};

/* â”€â”€ Jugadores precargados (base original) â”€â”€ */
var SEED_PLAYERS = [
  { id:1771189672901, name:'DIEGO',        sex:'M', position:'tirador', tiradorScore:8,  zagueroScore:7,  present:false },
  { id:1771189692594, name:'NINO',         sex:'M', position:'tirador', tiradorScore:7,  zagueroScore:8,  present:false },
  { id:1771189701354, name:'ABEL',         sex:'M', position:'tirador', tiradorScore:6,  zagueroScore:6,  present:false },
  { id:1771189715561, name:'OSCAR JAMPI',  sex:'M', position:'zaguero', tiradorScore:6,  zagueroScore:9,  present:false },
  { id:1771189732424, name:'PERRIKA',      sex:'M', position:'zaguero', tiradorScore:6,  zagueroScore:9,  present:false },
  { id:1771189766868, name:'FREDY',        sex:'M', position:'tirador', tiradorScore:10, zagueroScore:10, present:false },
  { id:1771189800608, name:'CINTIA',       sex:'F', position:'tirador', tiradorScore:9,  zagueroScore:6,  present:false },
  { id:1771189821615, name:'CRISTINA',     sex:'F', position:'zaguero', tiradorScore:8,  zagueroScore:8,  present:false },
  { id:1771189835524, name:'THELMA',       sex:'F', position:'zaguero', tiradorScore:7,  zagueroScore:7,  present:false },
  { id:1771189924803, name:'MIREYA',       sex:'F', position:'zaguero', tiradorScore:3,  zagueroScore:5,  present:false },
  { id:1771189964358, name:'MONICA JAMPI', sex:'F', position:'zaguero', tiradorScore:4,  zagueroScore:4,  present:false },
  { id:1771190016679, name:'MELINA',       sex:'F', position:'zaguero', tiradorScore:6,  zagueroScore:7,  present:false },
  { id:1771190032753, name:'DANIEL',       sex:'M', position:'zaguero', tiradorScore:7,  zagueroScore:6,  present:false },
  { id:1771190122665, name:'ZULMA',        sex:'F', position:'zaguero', tiradorScore:7,  zagueroScore:6,  present:false },
  { id:1771190158750, name:'JOSE',         sex:'M', position:'zaguero', tiradorScore:7,  zagueroScore:7,  present:false },
  { id:1771191209101, name:'CARLOS SOSA',  sex:'M', position:'tirador', tiradorScore:9,  zagueroScore:6,  present:false },
  { id:1771191234314, name:'CRISTINA B',   sex:'F', position:'zaguero', tiradorScore:5,  zagueroScore:5,  present:false },
  { id:1771192030573, name:'ADRIANA',      sex:'F', position:'zaguero', tiradorScore:3,  zagueroScore:3,  present:false },
  { id:1771192295073, name:'NESTOR',       sex:'M', position:'tirador', tiradorScore:9,  zagueroScore:9,  present:false },
  { id:1771192332274, name:'DIEGUITO',     sex:'M', position:'zaguero', tiradorScore:7,  zagueroScore:7,  present:false },
];

function normalizePlayer(p, idx) {
  return {
    id:           p.id           || (Date.now() + idx + Math.random()),
    name:         p.name         || '',
    sex:          p.sex          || 'M',
    tiradorScore: p.tiradorScore !== undefined ? p.tiradorScore : (p.score || 5),
    zagueroScore: p.zagueroScore !== undefined ? p.zagueroScore : (p.score || 5),
    position:     p.position     || 'tirador',
    present:      p.present      || false
  };
}

/* â”€â”€ Persistencia â”€â”€ */
function loadPlayers() {
  try {
    /* Intentar primero la clave nueva */
    var raw = localStorage.getItem('newcom-v7');
    /* Si no existe, intentar clave vieja */
    if (!raw) raw = localStorage.getItem('newcom-players');
    if (raw) {
      var arr = JSON.parse(raw);
      if (arr && arr.length > 0) {
        S.players = arr.map(normalizePlayer);
        return;
      }
    }
  } catch(e) {}
  /* Si no hay nada guardado, cargar la base semilla */
  S.players = SEED_PLAYERS.map(function(p, i) {
    return normalizePlayer(p, i);
  });
  save();
}

function save() {
  try { localStorage.setItem('newcom-v7', JSON.stringify(S.players)); } catch(e){}
}

/* â”€â”€ Exportar jugadores â”€â”€ */
function exportPlayers() {
  var data = JSON.stringify(S.players, null, 2);
  /* Intentar copiar al portapapeles */
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(data).then(function(){
      alert('âœ… Jugadores copiados al portapapeles.\nPegÃ¡ el texto en cualquier lugar para guardarlo.');
    }).catch(function(){ showExportModal(data); });
  } else {
    showExportModal(data);
  }
}

function showExportModal(data) {
  var overlay = el('div','');
  overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.85);z-index:10000;padding:20px;display:-webkit-box;display:-webkit-flex;display:flex;-webkit-box-orient:vertical;-webkit-flex-direction:column;flex-direction:column;';
  var title = el('h2',''); title.style.cssText='color:#a855f7;margin-bottom:12px;'; title.textContent='Exportar Jugadores';
  var instr = el('p',''); instr.style.cssText='color:#c4b5fd;font-size:.8rem;margin-bottom:10px;'; instr.textContent='SeleccionÃ¡ todo el texto y copialo para guardarlo.';
  var ta = document.createElement('textarea');
  ta.value = data;
  ta.style.cssText='width:100%;-webkit-flex:1;flex:1;background:#0a0618;color:#a78bfa;border:2px solid #7c3aed;border-radius:8px;padding:10px;font-size:.72rem;resize:none;';
  ta.readOnly = true;
  ta.onclick = function(){ this.select(); };
  var bClose = el('button','btn btn-purple'); bClose.style.marginTop='12px'; bClose.textContent='Cerrar';
  bClose.onclick = function(){ document.body.removeChild(overlay); };
  overlay.appendChild(title); overlay.appendChild(instr); overlay.appendChild(ta); overlay.appendChild(bClose);
  document.body.appendChild(overlay);
  setTimeout(function(){ ta.select(); }, 100);
}

/* â”€â”€ Importar jugadores â”€â”€ */
function showImportModal() {
  var overlay = el('div','');
  overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.85);z-index:10000;padding:20px;display:-webkit-box;display:-webkit-flex;display:flex;-webkit-box-orient:vertical;-webkit-flex-direction:column;flex-direction:column;';
  var title = el('h2',''); title.style.cssText='color:#a855f7;margin-bottom:12px;'; title.textContent='Importar Jugadores';
  var instr = el('p',''); instr.style.cssText='color:#c4b5fd;font-size:.8rem;margin-bottom:10px;'; instr.textContent='PegÃ¡ el JSON exportado anteriormente y tocÃ¡ Importar.';
  var ta = document.createElement('textarea');
  ta.style.cssText='width:100%;-webkit-flex:1;flex:1;background:#0a0618;color:#a78bfa;border:2px solid #7c3aed;border-radius:8px;padding:10px;font-size:.72rem;resize:none;';
  ta.placeholder='PegÃ¡ aquÃ­ el JSON...';
  var btnRow2 = el('div','btn-row'); btnRow2.style.marginTop='12px';
  var bImp = el('button','btn btn-green'); bImp.textContent='Importar';
  bImp.onclick = function(){
    try {
      var arr = JSON.parse(ta.value);
      if (!Array.isArray(arr)) throw new Error();
      S.players = arr.map(normalizePlayer);
      save();
      document.body.removeChild(overlay);
      render();
    } catch(e) { alert('âŒ Formato invÃ¡lido. Asegurate de pegar el JSON completo.'); }
  };
  var bClose = el('button','btn btn-red'); bClose.textContent='Cancelar';
  bClose.onclick = function(){ document.body.removeChild(overlay); };
  btnRow2.appendChild(bImp); btnRow2.appendChild(bClose);
  overlay.appendChild(title); overlay.appendChild(instr); overlay.appendChild(ta); overlay.appendChild(btnRow2);
  document.body.appendChild(overlay);
}

/* â”€â”€ Detectar iOS para mostrar banner â”€â”€ */
function isIOS() {
  return /iP(hone|ad|od)/.test(navigator.userAgent);
}
function isInStandaloneMode() {
  return (window.navigator.standalone === true) ||
         (window.matchMedia('(display-mode: standalone)').matches);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ALGORITMO DE ARMADO DE EQUIPOS
   â€” Exactamente 6 por equipo
   â€” Balanceo de puntaje por posiciÃ³n
   â€” Balanceo de gÃ©nero
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function buildTeams() {
  var present = S.players.filter(function(p) { return p.present; });
  if (present.length < 12) {
    alert('Se necesitan al menos 12 jugadores presentes.\nHay ' + present.length + '.');
    return;
  }

  var numTeams = Math.floor(present.length / 6);
  var teams = [];
  var i;
  for (i = 0; i < numTeams; i++) teams.push([]);

  /* Separar por posiciÃ³n + sexo, ordenados por puntaje desc */
  function byTira(a, b) { return b.tiradorScore - a.tiradorScore; }
  function byZag(a, b)  { return b.zagueroScore - a.zagueroScore; }

  var tiraM = present.filter(function(p){ return p.position==='tirador'&&p.sex==='M'; }).sort(byTira);
  var tiraF = present.filter(function(p){ return p.position==='tirador'&&p.sex==='F'; }).sort(byTira);
  var zagM  = present.filter(function(p){ return p.position==='zaguero'&&p.sex==='M'; }).sort(byZag);
  var zagF  = present.filter(function(p){ return p.position==='zaguero'&&p.sex==='F'; }).sort(byZag);

  /* Intercalar M y F para distribuir parejo desde el inicio */
  function interleave(arrM, arrF) {
    var out = [], max = Math.max(arrM.length, arrF.length);
    for (var i = 0; i < max; i++) {
      if (i < arrM.length) out.push(arrM[i]);
      if (i < arrF.length) out.push(arrF[i]);
    }
    return out;
  }

  var tiraPool = interleave(tiraM, tiraF);
  var zagPool  = interleave(zagM,  zagF);

  /* DistribuciÃ³n serpiente â€” tiradores (2-3 por equipo) */
  var totalTira    = tiraPool.length;
  var tiraPerTeam  = Math.floor(totalTira / numTeams);
  var minTira      = Math.max(2, Math.min(3, tiraPerTeam));
  var dir = 1, round, idx;

  for (round = 0; round < minTira; round++) {
    for (i = 0; i < numTeams && tiraPool.length > 0; i++) {
      idx = dir === 1 ? i : numTeams - 1 - i;
      teams[idx].push(tiraPool.shift());
    }
    dir *= -1;
  }

  /* DistribuciÃ³n serpiente â€” zagueros (llenar hasta 6) */
  var safety = 0;
  dir = 1;
  while (zagPool.length > 0 && hasSpace(teams) && safety++ < 2000) {
    for (i = 0; i < numTeams && zagPool.length > 0; i++) {
      idx = dir === 1 ? i : numTeams - 1 - i;
      if (teams[idx].length < 6) teams[idx].push(zagPool.shift());
    }
    dir *= -1;
  }

  /* Tiradores sobrantes rellenan huecos */
  safety = 0;
  while (tiraPool.length > 0 && hasSpace(teams) && safety++ < 2000) {
    for (i = 0; i < numTeams && tiraPool.length > 0; i++) {
      if (teams[i].length < 6 &&
          teams[i].filter(function(p){ return p.position==='tirador'; }).length < 3) {
        teams[i].push(tiraPool.shift());
      }
    }
  }

  /* Banca = presentes no asignados (sin duplicados) */
  var usedIds = {};
  teams.forEach(function(t){ t.forEach(function(p){ usedIds[p.id] = true; }); });
  var bench = present.filter(function(p){ return !usedIds[p.id]; });

  /* â”€â”€ Balanceo de puntaje â”€â”€ */
  function sumTira(t){ return t.filter(function(p){ return p.position==='tirador'; }).reduce(function(s,p){ return s+p.tiradorScore; },0); }
  function sumZag(t) { return t.filter(function(p){ return p.position==='zaguero'; }).reduce(function(s,p){ return s+p.zagueroScore; },0); }

  var iter, swapped, tS, zS, maxT, minT, maxZ, minZ, hi, lo, p1, p2, nd;
  for (iter = 0; iter < 300; iter++) {
    tS = teams.map(sumTira); zS = teams.map(sumZag);
    maxT = Math.max.apply(null,tS); minT = Math.min.apply(null,tS);
    maxZ = Math.max.apply(null,zS); minZ = Math.min.apply(null,zS);
    if (maxT-minT <= 2 && maxZ-minZ <= 2) break;
    swapped = false;

    if (maxT-minT >= maxZ-minZ) {
      hi = indexOf(tS,maxT); lo = indexOf(tS,minT);
      swapped = trySwap(teams[hi], teams[lo], 'tirador', 'tiradorScore', maxT-minT) || swapped;
    } else {
      hi = indexOf(zS,maxZ); lo = indexOf(zS,minZ);
      swapped = trySwap(teams[hi], teams[lo], 'zaguero', 'zagueroScore', maxZ-minZ) || swapped;
    }
    if (!swapped) break;
  }

  /* â”€â”€ Balanceo de gÃ©nero â”€â”€ */
  var fC, maxF, minF;
  for (iter = 0; iter < 200; iter++) {
    fC  = teams.map(function(t){ return t.filter(function(p){ return p.sex==='F'; }).length; });
    maxF = Math.max.apply(null,fC); minF = Math.min.apply(null,fC);
    if (maxF-minF <= 1) break;
    hi = indexOf(fC,maxF); lo = indexOf(fC,minF);
    swapped = false;
    outer: for (var a = 0; a < teams[hi].length; a++) {
      for (var b = 0; b < teams[lo].length; b++) {
        p1 = teams[hi][a]; p2 = teams[lo][b];
        if (p1.sex==='F' && p2.sex==='M' && p1.position===p2.position) {
          teams[hi][a]=p2; teams[lo][b]=p1; swapped=true; break outer;
        }
      }
    }
    if (!swapped) break;
  }

  S.teams = teams;
  S.bench = bench;
  S.view  = 'teams';
  render();
}

function hasSpace(teams) {
  for (var i = 0; i < teams.length; i++) if (teams[i].length < 6) return true;
  return false;
}
function indexOf(arr, val) {
  for (var i = 0; i < arr.length; i++) if (arr[i] === val) return i;
  return 0;
}
function trySwap(teamHi, teamLo, pos, scoreKey, diff) {
  for (var i = 0; i < teamHi.length; i++) {
    for (var j = 0; j < teamLo.length; j++) {
      var p1 = teamHi[i], p2 = teamLo[j];
      if (p1.position===pos && p2.position===pos) {
        var hiSum = teamHi.reduce(function(s,p){ return s+(p.position===pos?p[scoreKey]:0); },0);
        var loSum = teamLo.reduce(function(s,p){ return s+(p.position===pos?p[scoreKey]:0); },0);
        var nd = Math.abs((hiSum-p1[scoreKey]+p2[scoreKey])-(loSum-p2[scoreKey]+p1[scoreKey]));
        if (nd < diff) { teamHi[i]=p2; teamLo[j]=p1; return true; }
      }
    }
  }
  return false;
}

function teamScore(team) {
  return team.reduce(function(s,p){ return s+(p.position==='tirador'?p.tiradorScore:p.zagueroScore); }, 0);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HELPERS DOM
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function el(tag, cls) {
  var e = document.createElement(tag);
  if (cls) e.className = cls;
  return e;
}
function txt(str) { return document.createTextNode(str); }
function append(parent) {
  for (var i = 1; i < arguments.length; i++) parent.appendChild(arguments[i]);
  return parent;
}

/* SVG icons (inline strings) */
var IC = {
  db:   '<svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>',
  add:  '<svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" x2="19" y1="8" y2="14"/><line x1="22" x2="16" y1="11" y2="11"/></svg>',
  shuf: '<svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 18h1.4c1.3 0 2.5-.6 3.3-1.7l6.1-8.6c.7-1.1 2-1.7 3.3-1.7H22"/><polyline points="18 2 22 6 18 10"/><path d="M2 6h1.9c1.5 0 2.9.9 3.6 2.2"/><path d="M22 18h-5.9c-1.3 0-2.6-.7-3.3-1.8l-.5-.8"/><polyline points="18 14 22 18 18 22"/></svg>',
  ref:  '<svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>',
  edit: '<svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>',
  x:    '<svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>',
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RENDER PRINCIPAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function render() {
  var app = document.getElementById('app');
  app.innerHTML = '';

  /* Header */
  var hdr = el('div','header');
  var h1  = el('h1',''); h1.textContent = 'NEWCOM';
  var hp  = el('p','');  hp.textContent = 'ğŸ  Team Builder Pro  Â·  v7.0';
  append(hdr, h1, hp);
  app.appendChild(hdr);

  /* Banner iOS "Agregar a pantalla de inicio" */
  if (isIOS() && !isInStandaloneMode() && S.showBanner !== false) {
    var banner = el('div','install-banner');
    banner.innerHTML = 'ğŸ“² <strong>InstalÃ¡ la app:</strong>&nbsp; tocÃ¡ <strong>Compartir</strong> â†’ <em>"Agregar a inicio"</em>';
    var closeBtn = el('button','');
    closeBtn.textContent = 'âœ•';
    closeBtn.onclick = function(){ S.showBanner = false; render(); };
    banner.appendChild(closeBtn);
    app.appendChild(banner);
    S.showBanner = true;
  }

  /* Tabs */
  renderTabs(app);

  /* Contenido */
  if (S.view === 'database') renderDatabase(app);
  else                        renderTeams(app);

  /* Footer */
  var foot = el('div','footer');
  foot.textContent = 'ğŸ  NEWCOM TEAM BUILDER PRO  Â·  6 por equipo  Â·  Balance puntaje y gÃ©nero';
  app.appendChild(foot);
}

function renderTabs(app) {
  var tabs = el('div','tabs');
  var present = S.players.filter(function(p){ return p.present; });

  var tDB = el('button','tab-btn tab-db' + (S.view==='database' ? ' active' : ''));
  tDB.innerHTML = IC.db + ' Base de Datos';
  tDB.onclick = function(){ S.view='database'; render(); };
  tabs.appendChild(tDB);

  if (S.teams) {
    var tT = el('button','tab-btn tab-teams' + (S.view==='teams' ? ' active' : ''));
    tT.innerHTML = 'âš¡ Equipos (' + S.teams.length + ')';
    tT.onclick = function(){ S.view='teams'; render(); };
    tabs.appendChild(tT);
  }
  app.appendChild(tabs);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   VISTA: BASE DE DATOS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderDatabase(app) {
  var present = S.players.filter(function(p){ return p.present; });

  /* Botones de acciÃ³n */
  var btnRow = el('div','btn-row');

  var bAdd = el('button','btn btn-purple');
  bAdd.innerHTML = IC.add + ' Agregar Jugador';
  bAdd.onclick = function(){
    S.showForm = !S.showForm;
    S.editId = null;
    S.form = { name:'', sex:'M', tiradorScore:5, zagueroScore:5, position:'tirador' };
    render();
  };
  btnRow.appendChild(bAdd);

  var canBuild = present.length >= 12;
  var bBuild = el('button','btn ' + (canBuild ? 'btn-green' : 'btn-gray'));
  bBuild.innerHTML = IC.shuf + ' ' + (S.teams ? 'Reorganizar' : 'Armar Equipos');
  if (canBuild) bBuild.onclick = buildTeams;
  btnRow.appendChild(bBuild);

  if (present.length > 0) {
    var bReset = el('button','btn btn-orange');
    bReset.innerHTML = IC.ref + ' Nuevo Partido';
    bReset.onclick = function(){
      if (confirm('Â¿Marcar todos como ausentes?')) {
        S.players.forEach(function(p){ p.present = false; });
        S.teams = null; S.bench = []; S.view = 'database';
        save(); render();
      }
    };
    btnRow.appendChild(bReset);
  }

  var bExp = el('button','btn btn-gray');
  bExp.innerHTML = 'ğŸ“¤ Exportar';
  bExp.onclick = exportPlayers;
  btnRow.appendChild(bExp);

  var bImp = el('button','btn btn-gray');
  bImp.innerHTML = 'ğŸ“¥ Importar';
  bImp.onclick = showImportModal;
  btnRow.appendChild(bImp);
  app.appendChild(btnRow);

  /* Formulario */
  if (S.showForm || S.editId) app.appendChild(buildForm());

  /* Panel de jugadores */
  var panel = el('div','panel');
  var ph2 = el('h2',''); ph2.style.color='#a855f7'; ph2.style.marginBottom='4px';
  ph2.textContent = 'ğŸ“‹ Base de Datos';
  panel.appendChild(ph2);

  var sub = el('p',''); sub.style.cssText='color:#c4b5fd;font-size:.8rem;margin-bottom:12px';
  sub.textContent = present.length + ' presentes / ' + S.players.length + ' total â€” TocÃ¡ para marcar presencia';
  panel.appendChild(sub);

  if (present.length < 12) {
    var warn = el('div','alert-warn');
    warn.textContent = 'âš ï¸  Faltan ' + (12-present.length) + ' jugadores mÃ¡s para poder armar equipos.';
    panel.appendChild(warn);
  }

  var grid = el('div','players-grid');
  S.players.forEach(function(p){ grid.appendChild(makePlayerCard(p)); });
  panel.appendChild(grid);
  app.appendChild(panel);
}

function makePlayerCard(player) {
  var card = el('div','player-card ' + (player.present ? 'present' : 'absent'));

  /* Botones editar/eliminar */
  var actions = el('div','card-actions');
  var bEdit = el('button','icon-btn icon-btn-edit'); bEdit.innerHTML = IC.edit;
  bEdit.onclick = function(e){ e.stopPropagation(); startEdit(player); };
  var bDel = el('button','icon-btn icon-btn-del'); bDel.innerHTML = IC.x;
  bDel.onclick = function(e){
    e.stopPropagation();
    if (confirm('Â¿Eliminar a ' + player.name + '?')) {
      S.players = S.players.filter(function(p){ return p.id !== player.id; });
      save(); render();
    }
  };
  append(actions, bEdit, bDel);
  card.appendChild(actions);

  var nm = el('div','player-card-name'); nm.textContent = player.name;
  card.appendChild(nm);

  var badges = el('div','badges');
  var bSex = el('span','badge ' + (player.sex==='M' ? 'b-blue' : 'b-pink'));
  bSex.textContent = player.sex==='M' ? 'â™‚ M' : 'â™€ F';
  var bPos = el('span','badge ' + (player.position==='tirador' ? 'b-orange' : 'b-cyan'));
  bPos.textContent = player.position==='tirador' ? 'Tirador' : 'Zaguero';
  badges.appendChild(bSex); badges.appendChild(bPos);
  if (player.present) {
    var bP = el('span','badge b-green'); bP.textContent = 'âœ“ Presente';
    badges.appendChild(bP);
  }
  card.appendChild(badges);

  card.onclick = function(){
    player.present = !player.present;
    save(); render();
  };
  return card;
}

function startEdit(player) {
  S.editId = player.id; S.showForm = false;
  S.form = { name:player.name, sex:player.sex, tiradorScore:player.tiradorScore, zagueroScore:player.zagueroScore, position:player.position };
  render();
}

function buildForm() {
  var panel = el('div','panel');
  var h2 = el('h2',''); h2.style.color='#a855f7'; h2.style.marginBottom='14px';
  h2.textContent = S.editId ? 'âœï¸  Editar Jugador' : 'â•  Nuevo Jugador';
  panel.appendChild(h2);

  var grid = el('div','form-grid');

  /* Nombre */
  var gN = el('div','form-group'), lN = el('label',''); lN.textContent = 'Nombre';
  var iN = document.createElement('input'); iN.type='text'; iN.value=S.form.name; iN.placeholder='Nombre del jugador';
  iN.oninput = function(){ S.form.name = this.value; };
  append(gN, lN, iN); grid.appendChild(gN);

  /* Sexo */
  var gS = el('div','form-group'), lS = el('label',''); lS.textContent = 'Sexo';
  var sS = document.createElement('select');
  [['M','Masculino'],['F','Femenino']].forEach(function(v){
    var o=document.createElement('option'); o.value=v[0]; o.textContent=v[1];
    if(S.form.sex===v[0]) o.selected=true; sS.appendChild(o);
  });
  sS.onchange = function(){ S.form.sex = this.value; };
  append(gS, lS, sS); grid.appendChild(gS);

  /* Nivel Tirador */
  var gT = el('div','form-group');
  var lT = el('label',''); lT.id='_lts'; lT.textContent = 'Nivel Tirador: ' + S.form.tiradorScore;
  var iT = document.createElement('input'); iT.type='range'; iT.min=1; iT.max=10; iT.value=S.form.tiradorScore;
  iT.oninput = function(){ S.form.tiradorScore=parseInt(this.value); document.getElementById('_lts').textContent='Nivel Tirador: '+this.value; };
  append(gT, lT, iT); grid.appendChild(gT);

  /* Nivel Zaguero */
  var gZ = el('div','form-group');
  var lZ = el('label',''); lZ.id='_lzs'; lZ.textContent = 'Nivel Zaguero: ' + S.form.zagueroScore;
  var iZ = document.createElement('input'); iZ.type='range'; iZ.min=1; iZ.max=10; iZ.value=S.form.zagueroScore;
  iZ.oninput = function(){ S.form.zagueroScore=parseInt(this.value); document.getElementById('_lzs').textContent='Nivel Zaguero: '+this.value; };
  append(gZ, lZ, iZ); grid.appendChild(gZ);

  /* PosiciÃ³n */
  var gP = el('div','form-group form-full'), lP = el('label',''); lP.textContent = 'PosiciÃ³n Preferida';
  var sP = document.createElement('select');
  [['tirador','Tirador'],['zaguero','Zaguero']].forEach(function(v){
    var o=document.createElement('option'); o.value=v[0]; o.textContent=v[1];
    if(S.form.position===v[0]) o.selected=true; sP.appendChild(o);
  });
  sP.onchange = function(){ S.form.position = this.value; };
  append(gP, lP, sP); grid.appendChild(gP);

  panel.appendChild(grid);

  /* Acciones */
  var fa = el('div','form-actions');
  var bSave = el('button','btn btn-green');
  bSave.textContent = S.editId ? 'Actualizar' : 'Guardar';
  bSave.onclick = function(){
    if (!S.form.name.trim()) { alert('Por favor ingresÃ¡ un nombre.'); return; }
    if (S.editId) {
      S.players = S.players.map(function(p){
        return p.id===S.editId ? { id:p.id, name:S.form.name, sex:S.form.sex, tiradorScore:S.form.tiradorScore, zagueroScore:S.form.zagueroScore, position:S.form.position, present:p.present } : p;
      });
      if (S.teams) S.teams = S.teams.map(function(t){ return t.map(function(p){ return p.id===S.editId ? Object.assign({},p,S.form) : p; }); });
      S.editId = null;
    } else {
      S.players.push({ id:Date.now(), name:S.form.name, sex:S.form.sex, tiradorScore:S.form.tiradorScore, zagueroScore:S.form.zagueroScore, position:S.form.position, present:false });
    }
    S.showForm = false;
    S.form = { name:'', sex:'M', tiradorScore:5, zagueroScore:5, position:'tirador' };
    save(); render();
  };
  var bCan = el('button','btn btn-red'); bCan.textContent = 'Cancelar';
  bCan.onclick = function(){ S.showForm=false; S.editId=null; render(); };
  append(fa, bSave, bCan);
  panel.appendChild(fa);
  return panel;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   VISTA: EQUIPOS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderTeams(app) {
  var hint = el('p','drag-hint');
  hint.textContent = 'âœ¦ MantenÃ© presionado y arrastrÃ¡ un jugador para moverlo âœ¦';
  app.appendChild(hint);

  var grid = el('div','teams-grid');
  S.teams.forEach(function(team, tIdx){ grid.appendChild(makeTeamCard(team, tIdx)); });
  app.appendChild(grid);

  /* Banca */
  if (S.bench && S.bench.length > 0) {
    var bp = el('div','panel panel-orange');
    bp.setAttribute('data-zone','bench');
    var bh = el('h2',''); bh.style.color='#fb923c'; bh.style.marginBottom='10px';
    bh.textContent = 'ğŸ“‹ Sin Equipo (' + S.bench.length + ')';
    bp.appendChild(bh);

    var bg = el('div','bench-grid');
    S.bench.forEach(function(player){
      var chip = el('div','bench-chip');
      chip.setAttribute('data-pid', player.id);
      chip.setAttribute('data-from','bench');
      var tz = el('span','tz ' + (player.sex==='M'?'tz-m':'tz-f'));
      tz.textContent = player.position==='tirador' ? 'T' : 'Z';
      var nm = el('span','p-name'); nm.textContent = player.name;
      append(chip, tz, nm);
      bg.appendChild(chip);
      makeDraggable(chip, player.id, 'bench');
    });
    bp.appendChild(bg);
    makeDropZone(bp, 'bench');
    app.appendChild(bp);
  }
}

function makeTeamCard(team, tIdx) {
  var ci = tIdx % 6;
  var card = el('div','team-card tc'+ci);
  card.setAttribute('data-zone', tIdx);

  /* Header */
  var hdr = el('div','team-header');
  var title = el('h3','tt'+ci); title.textContent = 'EQUIPO ' + (tIdx+1);
  var right = el('div','');
  var pts = el('div','team-pts'); pts.textContent = teamScore(team).toFixed(0) + ' pts';
  var cnt = el('div','team-count'); cnt.textContent = team.length + ' jugadores';
  append(right, pts, cnt);
  append(hdr, title, right);
  card.appendChild(hdr);

  /* Advertencias */
  if (team.length !== 6) {
    var w1 = el('div','alert-err');
    w1.textContent = 'âš ï¸  Este equipo tiene ' + team.length + ' jugadores (necesita 6)';
    card.appendChild(w1);
  }
  var tiraCount = team.filter(function(p){ return p.position==='tirador'; }).length;
  if (tiraCount < 2 || tiraCount > 3) {
    var w2 = el('div','alert-err');
    w2.textContent = 'âš ï¸  Debe tener 2â€“3 tiradores (tiene ' + tiraCount + ')';
    card.appendChild(w2);
  }

  /* Lista de jugadores: tiradores primero, cada grupo por puntaje desc */
  var sorted = team.slice().sort(function(a, b){
    if (a.position !== b.position) return a.position==='tirador' ? -1 : 1;
    var sa = a.position==='tirador' ? a.tiradorScore : a.zagueroScore;
    var sb = b.position==='tirador' ? b.tiradorScore : b.zagueroScore;
    return sb - sa;
  });

  var list = el('div',''); list.style.marginTop = '4px';

  if (sorted.length === 0) {
    var hint = el('div','drop-hint'); hint.textContent = 'SoltÃ¡ un jugador aquÃ­';
    list.appendChild(hint);
  }

  var prevPos = null;
  sorted.forEach(function(player){
    /* Separador visual entre tiradores y zagueros */
    if (prevPos === 'tirador' && player.position === 'zaguero') {
      list.appendChild(el('hr','pos-divider'));
    }
    prevPos = player.position;

    var row = el('div','player-row');
    row.setAttribute('data-pid', player.id);
    row.setAttribute('data-from', tIdx);
    var tz = el('span','tz ' + (player.sex==='M'?'tz-m':'tz-f'));
    tz.textContent = player.position==='tirador' ? 'T' : 'Z';
    var nm = el('span','p-name'); nm.textContent = player.name;
    append(row, tz, nm);
    list.appendChild(row);
    makeDraggable(row, player.id, tIdx);
  });

  card.appendChild(list);
  makeDropZone(card, tIdx);
  return card;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DRAG & DROP â€” Mouse + Touch (iPad 3 / Android)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
var DS = { active:false, playerId:null, fromZone:null, rowEl:null };
var ghost = document.getElementById('drag-ghost');

function makeDraggable(rowEl, playerId, fromZone) {
  /* â”€â”€ Mouse drag (PC / Android Chrome) â”€â”€ */
  rowEl.draggable = true;
  rowEl.addEventListener('dragstart', function(e){
    DS = { active:true, playerId:playerId, fromZone:fromZone, rowEl:rowEl };
    rowEl.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/plain', String(playerId));
  });
  rowEl.addEventListener('dragend', function(){
    rowEl.classList.remove('dragging');
    DS.active = false;
    clearDropHighlights();
  });

  /* â”€â”€ Touch drag (iPad 3 / iPhone / Android) â”€â”€ */
  rowEl.addEventListener('touchstart', function(e){
    var t = e.touches[0];
    DS = { active:true, playerId:playerId, fromZone:fromZone, rowEl:rowEl };
    rowEl.classList.add('dragging');
    var nameEl = rowEl.querySelector('.p-name') || rowEl.querySelector('.p-name');
    ghost.textContent = nameEl ? nameEl.textContent : '';
    ghost.style.display = 'block';
    positionGhost(t.clientX, t.clientY);
  }, { passive:true });

  rowEl.addEventListener('touchmove', function(e){
    e.preventDefault(); /* evita scroll mientras se arrastra */
    var t = e.touches[0];
    positionGhost(t.clientX, t.clientY);
    ghost.style.display = 'none';
    var under = document.elementFromPoint(t.clientX, t.clientY);
    ghost.style.display = 'block';
    clearDropHighlights();
    if (under) {
      var zone = closestZone(under);
      if (zone) zone.classList.add('drop-over');
    }
  }, { passive:false });

  rowEl.addEventListener('touchend', function(e){
    ghost.style.display = 'none';
    rowEl.classList.remove('dragging');
    clearDropHighlights();
    if (!DS.active) return;
    var t = e.changedTouches[0];
    ghost.style.display = 'none';
    var under = document.elementFromPoint(t.clientX, t.clientY);
    if (under) {
      var zone = closestZone(under);
      if (zone) {
        var toZone = zone.getAttribute('data-zone');
        var toIdx  = (toZone === 'bench') ? 'bench' : parseInt(toZone, 10);
        doSwap(DS.playerId, DS.fromZone, toIdx);
      }
    }
    DS.active = false;
  }, { passive:true });

  rowEl.addEventListener('touchcancel', function(){
    ghost.style.display = 'none';
    rowEl.classList.remove('dragging');
    clearDropHighlights();
    DS.active = false;
  }, { passive:true });
}

function makeDropZone(zoneEl, zoneId) {
  zoneEl.addEventListener('dragover', function(e){
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
    zoneEl.classList.add('drop-over');
  });
  zoneEl.addEventListener('dragleave', function(e){
    if (!zoneEl.contains(e.relatedTarget)) zoneEl.classList.remove('drop-over');
  });
  zoneEl.addEventListener('drop', function(e){
    e.preventDefault();
    zoneEl.classList.remove('drop-over');
    var pid = DS.active ? DS.playerId : parseFloat(e.dataTransfer.getData('text/plain'));
    var from = DS.active ? DS.fromZone : null;
    DS.active = false;
    if (pid && from !== null) doSwap(pid, from, zoneId);
  });
}

function positionGhost(x, y) {
  ghost.style.left = x + 'px';
  ghost.style.top  = (y - 20) + 'px';
}
function clearDropHighlights() {
  var els = document.querySelectorAll('.drop-over');
  for (var i = 0; i < els.length; i++) els[i].classList.remove('drop-over');
}
function closestZone(el) {
  while (el) {
    if (el.getAttribute && el.getAttribute('data-zone') !== null) return el;
    el = el.parentNode;
  }
  return null;
}

/* â”€â”€ Intercambio de jugador entre zonas â”€â”€ */
function doSwap(playerId, fromZone, toZone) {
  if (fromZone === toZone) return;

  var player = null;

  /* Sacar de fromZone */
  if (fromZone === 'bench') {
    var idx = findIdx(S.bench, playerId);
    if (idx === -1) return;
    player = S.bench.splice(idx, 1)[0];
  } else {
    var fi = parseInt(fromZone, 10);
    var idx = findIdx(S.teams[fi], playerId);
    if (idx === -1) return;
    player = S.teams[fi].splice(idx, 1)[0];
  }

  /* Poner en toZone */
  if (toZone === 'bench') {
    S.bench.push(player);
  } else {
    var ti = parseInt(toZone, 10);
    S.teams[ti].push(player);
    /* Si el equipo destino ya tenÃ­a 6, el primero sale a la banca */
    if (S.teams[ti].length > 6) {
      S.bench.push(S.teams[ti].shift());
    }
  }

  render();
}

function findIdx(arr, id) {
  for (var i = 0; i < arr.length; i++) if (arr[i].id === id) return i;
  return -1;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SERVICE WORKER â€” registrar externo
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
if ('serviceWorker' in navigator) {
  window.addEventListener('load', function() {
    navigator.serviceWorker.register('./sw.js').catch(function(e){
      console.log('SW error:', e);
    });
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INICIO
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
loadPlayers();
/* Mostrar banner iOS solo si no instalada */
S.showBanner = isIOS() && !isInStandaloneMode();
render();
</script>
</body>
</html>
